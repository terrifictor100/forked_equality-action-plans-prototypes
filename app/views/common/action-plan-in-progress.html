{% set showChanges = false %}
{% if not creatingNewActionPlan %}
  {% for action in data.db.actions %}
    {% if data[journeyShortCode][action.shortCode].status
      and data[journeyShortCode][action.shortCode].status != data.db.company.actionsInProgress[action.shortCode].status %}

      {% set showChanges = true %}
    {% endif %}
  {% endfor %}
{% endif %}

<dl class="govuk-summary-list action-plan-summary{{ "-with-changes" if showChanges}}">
  
  {% for action in data.db.actions %}
    {% set dbStatus = data.db.company.actionsInProgress[action.shortCode].status %}
    {% set submittedStatus = data[journeyShortCode][action.shortCode].status %}
    {% set submittedNarrative = data[journeyShortCode][action.shortCode].narrative %}

    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        {{action.title}}
        {% if submittedNarrative and submittedNarrative != "" %}
          {{ govukDetails({
            summaryText: "Your supporting narrative",
            text: submittedNarrative,
            classes: "govuk-!-margin-top-4 govuk-!-margin-bottom-4"
          }) }}
        {% endif %}
      </dt>
      <dd class="govuk-summary-list__value">
        {% if mustSubmit and not submittedStatus %}
          <a class="govuk-link" href="{{editUrl}}?actionShortCode={{action.shortCode}}">
            {{ unsubmittedLinkText }}
          </a>
        {% elif creatingNewActionPlan %}
          {{ submittedStatus | statusToTag | safe }}
        {% else %}
          {{ dbStatus | statusToTag | safe }}
          {% if submittedStatus and submittedStatus != dbStatus %}
            changed to {{ submittedStatus | statusToTag | safe }}
          {% endif %}
        {% endif %}
      </dd>
      <dd class="govuk-summary-list__actions">
        {% if submittedStatus or (not creatingNewActionPlan and not mustSubmit) %}
          <a class="govuk-link" href="{{editUrl}}?actionShortCode={{action.shortCode}}">Change</a>
        {% endif %}
      </dd>
    </div>

  {% endfor %}
  </dl>
